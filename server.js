// server.js - TPS COM IA REAL (OpenAI/Claude API)

const express = require('express');
const { MongoClient } = require('mongodb');
const path = require('path');
const axios = require('axios'); // Para chamadas de API

const app = express();
const PORT = process.env.PORT || 8080;

// CONFIGURA√á√ïES DA API DE IA (ESCOLHA UMA)
const AI_CONFIG = {
    // OP√á√ÉO 1: OpenAI GPT
    openai: {
        apiKey: process.env.OPENAI_API_KEY || 'sua-chave-openai-aqui',
        model: 'gpt-4',
        url: 'https://api.openai.com/v1/chat/completions'
    },
    
    // OP√á√ÉO 2: Claude API (Anthropic)
    claude: {
        apiKey: process.env.CLAUDE_API_KEY || 'sua-chave-claude-aqui',
        model: 'claude-3-sonnet-20240229',
        url: 'https://api.anthropic.com/v1/messages'
    },
    
    // OP√á√ÉO 3: Groq (GRATUITO e R√ÅPIDO!)
    groq: {
        apiKey: process.env.GROQ_API_KEY || 'sua-chave-groq-aqui',
        model: 'llama3-70b-8192',
        url: 'https://api.groq.com/openai/v1/chat/completions'
    }
};

// Escolha qual API usar (groq √© gratuita e excelente!)
const CURRENT_AI = 'groq'; // Mude para 'openai' ou 'claude' se preferir

// MongoDB Connection
const MONGO_URI = 'mongodb://localhost:27017';
const DB_NAME = 'tps_database';
let db;

MongoClient.connect(MONGO_URI)
  .then(client => {
    console.log('üóÑÔ∏è MongoDB conectado com sucesso');
    db = client.db(DB_NAME);
  })
  .catch(error => console.error('‚ùå Erro MongoDB:', error));

app.use(express.json());
app.use(express.static('public'));

// SISTEMA DE PROMPTS PO√âTICOS PARA IA REAL
const getSystemPrompt = (language) => {
    const prompts = {
        pt: `Voc√™ √© um CONCIERGE DE VIAGENS PO√âTICO LUXURY chamado TPS (The Poetic Suitcase).

PERSONALIDADE:
- Rom√¢ntico e sonhador, mas SEMPRE pr√°tico
- Especialista em experi√™ncias de viagem exclusivas
- Combina poesia com informa√ß√µes reais e √∫teis
- Cria conex√µes emocionais com destinos

ESTRUTURA OBRIGAT√ìRIA DE RESPOSTA:
1. **T√çTULO em negrito** do que est√° recomendando
2. **Frase po√©tica curta** (1 linha) sobre o destino/experi√™ncia
3. **3-5 recomenda√ß√µes ESPEC√çFICAS E REAIS** com:
   - Nome exato do lugar/hotel/restaurante
   - Localiza√ß√£o precisa
   - Pre√ßo aproximado realista em moeda apropriada
   - 2-3 caracter√≠sticas principais
   - Site ou forma de contato quando poss√≠vel
4. **Toque po√©tico final** (1-2 linhas) sobre a experi√™ncia
5. **Call-to-action** perguntando sobre pr√≥ximos passos

REGRAS OBRIGAT√ìRIAS:
- SEMPRE use informa√ß√µes REAIS (hot√©is, restaurantes, pre√ßos que existem)
- NUNCA invente pre√ßos irreais ou lugares que n√£o existem
- Mantenha respostas concisas (m√°ximo 200 palavras)
- Use emojis moderadamente para organiza√ß√£o visual
- Equilibre 70% informa√ß√£o pr√°tica + 30% poesia
- Responda APENAS em portugu√™s puro

EXEMPLO PERFEITO:
"üè® **HOT√âIS ROM√ÇNTICOS EM SANTORINI**

*Onde o azul infinito do Egeu abra√ßa almas apaixonadas...*

**Grace Hotel Santorini** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
üìç Imerovigli ‚Ä¢ üí∞ ‚Ç¨450-750/noite
üåÖ Vista caldera + spa Auriga + su√≠tes com piscina privativa
üìû grace-santorini.com

**Mystique Resort** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
üìç Oia ‚Ä¢ üí∞ ‚Ç¨600-1100/noite
üçæ Infinity pool + caverna de vinhos + butler 24h
üìû mystique.gr

**Canaves Oia Suites** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
üìç Oia ‚Ä¢ üí∞ ‚Ç¨400-800/noite
üíí Piscinas privativas + vista p√¥r do sol + spa hol√≠stico
üìû canaves.com

*Aqui, cada amanhecer √© uma promessa renovada de amor eterno...*

üéØ **Pr√≥ximo passo:** Quer restaurantes com vista para o p√¥r do sol? Ajuda com voos? Roteiro personalizado?"`,

        en: `You are a LUXURY POETIC TRAVEL CONCIERGE called TPS (The Poetic Suitcase).

PERSONALITY:
- Romantic and dreamy, but ALWAYS practical
- Expert in exclusive travel experiences  
- Combines poetry with real and useful information
- Creates emotional connections with destinations

MANDATORY RESPONSE STRUCTURE:
1. **Bold TITLE** of what you're recommending
2. **Short poetic phrase** (1 line) about destination/experience
3. **3-5 SPECIFIC AND REAL recommendations** with:
   - Exact name of place/hotel/restaurant
   - Precise location
   - Realistic approximate price in appropriate currency
   - 2-3 main characteristics
   - Website or contact when possible
4. **Final poetic touch** (1-2 lines) about the experience
5. **Call-to-action** asking about next steps

MANDATORY RULES:
- ALWAYS use REAL information (hotels, restaurants, prices that exist)
- NEVER invent unrealistic prices or places that don't exist
- Keep responses concise (maximum 200 words)
- Use emojis moderately for visual organization
- Balance 70% practical info + 30% poetry
- Respond ONLY in pure English

EXAMPLE:
"üè® **ROMANTIC HOTELS IN SANTORINI**

*Where infinite blue of the Aegean embraces passionate souls...*

**Grace Hotel Santorini** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
üìç Imerovigli ‚Ä¢ üí∞ ‚Ç¨450-750/night
üåÖ Caldera view + Auriga spa + private pool suites
üìû grace-santorini.com

[2 more specific real hotels]

*Here, each sunrise is a renewed promise of eternal love...*

üéØ **Next step:** Want sunset restaurants? Flight help? Custom itinerary?"`,

        es: `Eres un CONSERJE DE VIAJES PO√âTICO DE LUJO llamado TPS (The Poetic Suitcase).

PERSONALIDAD:
- Rom√°ntico y so√±ador, pero SIEMPRE pr√°ctico
- Experto en experiencias de viaje exclusivas
- Combina poes√≠a con informaci√≥n real y √∫til
- Crea conexiones emocionales con destinos

ESTRUCTURA OBLIGATORIA DE RESPUESTA:
1. **T√çTULO en negrita** de lo que recomiendas
2. **Frase po√©tica corta** (1 l√≠nea) sobre destino/experiencia
3. **3-5 recomendaciones ESPEC√çFICAS Y REALES** con:
   - Nombre exacto del lugar/hotel/restaurante
   - Ubicaci√≥n precisa
   - Precio aproximado realista en moneda apropiada
   - 2-3 caracter√≠sticas principales
   - Sitio web o contacto cuando sea posible
4. **Toque po√©tico final** (1-2 l√≠neas) sobre la experiencia
5. **Call-to-action** preguntando sobre pr√≥ximos pasos

REGLAS OBLIGATORIAS:
- SIEMPRE usa informaci√≥n REAL (hoteles, restaurantes, precios que existen)
- NUNCA inventes precios irreales o lugares que no existen
- Mant√©n respuestas concisas (m√°ximo 200 palabras)
- Usa emojis moderadamente para organizaci√≥n visual
- Equilibra 70% informaci√≥n pr√°ctica + 30% poes√≠a
- Responde SOLO en espa√±ol puro`
    };
    
    return prompts[language] || prompts.pt;
};

// FUN√á√ÉO PARA CHAMAR IA REAL (GROQ/OPENAI/CLAUDE)
const callRealAI = async (message, language, sessionId) => {
    try {
        const systemPrompt = getSystemPrompt(language);
        const config = AI_CONFIG[CURRENT_AI];
        
        let requestData;
        let headers;
        
        if (CURRENT_AI === 'groq' || CURRENT_AI === 'openai') {
            // Formato OpenAI/Groq
            requestData = {
                model: config.model,
                messages: [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    {
                        role: "user", 
                        content: message
                    }
                ],
                max_tokens: 1000,
                temperature: 0.7
            };
            
            headers = {
                'Authorization': `Bearer ${config.apiKey}`,
                'Content-Type': 'application/json'
            };
            
        } else if (CURRENT_AI === 'claude') {
            // Formato Claude (Anthropic)
            requestData = {
                model: config.model,
                max_tokens: 1000,
                system: systemPrompt,
                messages: [
                    {
                        role: "user",
                        content: message
                    }
                ]
            };
            
            headers = {
                'x-api-key': config.apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01'
            };
        }
        
        console.log(`ü§ñ Chamando ${CURRENT_AI.toUpperCase()} API...`);
        
        const response = await axios.post(config.url, requestData, { headers });
        
        let aiResponse;
        if (CURRENT_AI === 'groq' || CURRENT_AI === 'openai') {
            aiResponse = response.data.choices[0].message.content;
        } else if (CURRENT_AI === 'claude') {
            aiResponse = response.data.content[0].text;
        }
        
        console.log(`‚úÖ Resposta da IA recebida (${aiResponse.length} chars)`);
        return aiResponse;
        
    } catch (error) {
        console.error(`‚ùå Erro na API ${CURRENT_AI}:`, error.response?.data || error.message);
        
        // Fallback para resposta b√°sica se a API falhar
        return `üåü **EXPERI√äNCIAS EXTRAORDIN√ÅRIAS**

*Cada destino, uma hist√≥ria √∫nica para escrever...*

Desculpe, estou com dificuldades t√©cnicas no momento. Que tal me contar mais especificamente o que voc√™ procura?

**Posso ajudar com:**
‚Ä¢ Hot√©is rom√¢nticos em destinos espec√≠ficos
‚Ä¢ Restaurantes especiais
‚Ä¢ Dicas de viagem e voos
‚Ä¢ Roteiros personalizados

üéØ **Qual seu destino dos sonhos?**`;
    }
};

// API Endpoint principal para chat COM IA REAL
app.post('/api/chat/message', async (req, res) => {
    try {
        const { message, sessionId } = req.body;
        const userLanguage = req.headers['x-user-language'] || 'pt';
        
        console.log(`üìù Nova mensagem [${userLanguage}]:`, message);
        console.log(`ü§ñ Processando com ${CURRENT_AI.toUpperCase()} API...`);
        
        // Chamar IA REAL para gerar resposta
        const aiResponse = await callRealAI(message, userLanguage, sessionId);
        
        // Salvar conversa no MongoDB
        if (db) {
            await db.collection('conversations').insertOne({
                sessionId,
                userMessage: message,
                botResponse: aiResponse,
                language: userLanguage,
                timestamp: new Date(),
                type: 'real_ai_response',
                ai_provider: CURRENT_AI,
                practical_info: true
            });
        }
        
        res.json({
            success: true,
            response: aiResponse,
            type: 'real_ai',
            ai_provider: CURRENT_AI,
            language: userLanguage,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('‚ùå Erro no chat:', error);
        res.status(500).json({
            success: false,
            error: 'Erro interno do servidor',
            details: error.message
        });
    }
});

// Endpoint para testar conectividade da IA
app.get('/api/test-ai', async (req, res) => {
    try {
        const testMessage = "Quero um hotel rom√¢ntico em Paris";
        const response = await callRealAI(testMessage, 'pt', 'test-session');
        
        res.json({
            success: true,
            ai_provider: CURRENT_AI,
            test_response: response,
            message: 'IA funcionando perfeitamente!'
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: 'Falha no teste da IA',
            details: error.message
        });
    }
});

// Endpoint para analytics
app.get('/api/analytics', async (req, res) => {
    try {
        if (!db) {
            return res.status(500).json({ error: 'Database n√£o conectado' });
        }
        
        const totalMessages = await db.collection('conversations').countDocuments();
        const aiMessages = await db.collection('conversations').countDocuments({
            type: 'real_ai_response'
        });
        
        const languageStats = await db.collection('conversations').aggregate([
            { $group: { _id: '$language', count: { $sum: 1 } } }
        ]).toArray();
        
        const aiProviderStats = await db.collection('conversations').aggregate([
            { $group: { _id: '$ai_provider', count: { $sum: 1 } } }
        ]).toArray();
        
        res.json({
            totalMessages,
            aiMessages,
            languageStats,
            aiProviderStats,
            currentAI: CURRENT_AI,
            systemVersion: '3.0-real-ai',
            uptime: process.uptime()
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Endpoint para verificar configura√ß√£o da IA
app.get('/api/ai-status', (req, res) => {
    const config = AI_CONFIG[CURRENT_AI];
    const hasApiKey = config.apiKey && config.apiKey !== `sua-chave-${CURRENT_AI}-aqui`;
    
    res.json({
        current_ai: CURRENT_AI,
        model: config.model,
        has_api_key: hasApiKey,
        api_key_preview: hasApiKey ? config.apiKey.substring(0, 10) + '...' : 'N√ÉO CONFIGURADA',
        status: hasApiKey ? 'CONFIGURADO' : 'NECESS√ÅRIA CONFIGURA√á√ÉO',
        available_providers: Object.keys(AI_CONFIG)
    });
});

// Servir frontend
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'tps-gpt.html'));
});

// Health check
app.get('/api/health', (req, res) => {
    const config = AI_CONFIG[CURRENT_AI];
    const hasApiKey = config.apiKey && config.apiKey !== `sua-chave-${CURRENT_AI}-aqui`;
    
    res.json({
        status: 'healthy',
        ai_enabled: hasApiKey,
        ai_provider: CURRENT_AI,
        mongodb: db ? 'connected' : 'disconnected',
        version: '3.0-real-ai',
        features: {
            real_ai_responses: hasApiKey,
            multiple_languages: true,
            mongodb_storage: true,
            poetic_personality: true
        }
    });
});

// Iniciar servidor
app.listen(PORT, () => {
    const config = AI_CONFIG[CURRENT_AI];
    const hasApiKey = config.apiKey && config.apiKey !== `sua-chave-${CURRENT_AI}-aqui`;
    
    console.log('üöÄ TPS Server COM IA REAL iniciado!');
    console.log(`üåê URL: http://localhost:${PORT}`);
    console.log(`ü§ñ IA Provider: ${CURRENT_AI.toUpperCase()}`);
    console.log(`üîë API Key: ${hasApiKey ? 'CONFIGURADA ‚úÖ' : 'NECESS√ÅRIA ‚ùå'}`);
    console.log(`üé≠ Personalidade: Concierge Po√©tico Luxury`);
    console.log(`üó£Ô∏è Idiomas: 12 dispon√≠veis`);
    console.log(`üóÑÔ∏è MongoDB: ${db ? 'Conectado' : 'Aguardando conex√£o'}`);
    console.log('================================');
    console.log('üé≠ TPS - The Poetic Suitcase v3.0');
    if (hasApiKey) {
        console.log('‚úÖ IA REAL ATIVA - Sistema inteligente!');
    } else {
        console.log('‚ö†Ô∏è CONFIGURE SUA API KEY PARA ATIVAR IA');
        console.log(`üí° Configure: ${CURRENT_AI.toUpperCase()}_API_KEY`);
    }
    console.log('================================');
});