<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://hook.us2.make.com; object-src 'none'; connect-src 'self' https://www.google-analytics.com https://hook.us2.make.com https://tps-railway-api-production.up.railway.app;">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS ‚Äì Travel Personal Secretary</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SCFHQFYGHQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-SCFHQFYGHQ');
      console.log('üéØ Google Analytics carregado: G-SCFHQFYGHQ');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3d 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 15, 35, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.7);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(47, 46, 92, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            z-index: 1001;
            color: #00ff88;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, rgba(10, 10, 20, 0.98) 0%, rgba(15, 15, 25, 0.98) 100%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(58, 58, 109, 0.5);
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .language-selector {
            background: rgba(47, 46, 92, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .language-selector h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
        }

        .language-selector select {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid rgba(79, 70, 229, 0.4);
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            border-radius: 8px;
            width: 100%;
        }

        .language-selector select option {
            background: #2f2e5c;
            color: white;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #888;
            text-align: center;
            border-bottom: 2px solid rgba(58, 58, 109, 0.5);
            padding-bottom: 20px;
        }

        .sidebar-message {
            font-size: 14px;
            color: #ffd700;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .destinations-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 25px;
        }

        .destination-item {
            transition: all 0.4s ease;
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.8), rgba(15, 15, 25, 0.8));
            position: relative;
            opacity: 0.8;
            cursor: pointer;
        }

        .destination-item:hover {
            opacity: 1;
            transform: translateY(-2px);
        }

        .destination-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            filter: brightness(0.6);
        }

        .destination-item:hover img {
            filter: brightness(0.7);
        }

        .destination-item span {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            color: white;
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 11px;
            color: rgba(170, 170, 170, 0.7);
            text-align: center;
            padding: 20px 0 10px;
            border-top: 1px solid rgba(58, 58, 109, 0.3);
        }

        .main {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 60px 20px 20px;
            min-height: 100vh;
        }

        .logo-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            color: #3fa3ff;
            text-shadow: 0 0 25px rgba(63, 163, 255, 0.6);
            animation: logoGlow 3s ease-in-out infinite alternate;
            text-align: center;
        }

        @keyframes logoGlow {
            from { text-shadow: 0 0 25px rgba(63, 163, 255, 0.6); }
            to { text-shadow: 0 0 35px rgba(63, 163, 255, 0.8), 0 0 50px rgba(63, 163, 255, 0.4); }
        }

        .header-tabs {
            position: absolute;
            top: 100px;
            right: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-button {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
            flex: 1;
            max-width: 120px;
        }

        .tab-button:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3b36c8, #4f46e5);
            transform: translateY(-2px);
        }

        .chat-container {
            flex: 1;
            background: transparent;
            padding: 0 20px;
            overflow-y: auto;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            position: absolute;
            top: 220px;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            padding-bottom: 40px;
            scroll-behavior: smooth;
        }

        .conversation-line {
            width: 100%;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 15px;
            word-wrap: break-word;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .conversation-line.user {
            color: #b8c5ff;
        }

        .conversation-line.assistant {
            color: #ffd700;
            margin-bottom: 30px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .conversation-line.user .message-avatar {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
        }

        .conversation-line.assistant .message-avatar {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
        }

        .message-content {
            flex: 1;
            padding: 0;
            background: transparent;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .conversation-line.user .message-header {
            color: #6366f1;
        }

        .conversation-line.assistant .message-header {
            color: #ffd700;
        }

        .message-text {
            line-height: 1.6;
        }

        .input-container {
            position: fixed;
            bottom: 20px;
            left: 340px;
            right: 20px;
            display: flex;
            gap: 0;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.99);
            padding: 8px;
            border-radius: 18px;
            border: 1px solid rgba(79, 70, 229, 0.4);
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            min-height: 50px;
            max-height: 100px;
            resize: none;
            border: 2px solid #4f46e5;
            border-radius: 14px 0 0 14px;
            background: rgba(26, 26, 46, 0.98);
            color: white;
            font-size: 15px;
            font-family: inherit;
            line-height: 1.4;
            outline: none;
            pointer-events: auto !important;
            user-select: text !important;
        }

        .message-input:focus {
            border-color: #6d63ff;
        }

        .message-input::placeholder {
            color: #888;
        }

        .send-button {
            width: 90px;
            background: linear-gradient(135deg, #4f46e5, #6d63ff);
            border: none;
            border-radius: 0 14px 14px 0;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ESTILOS PARA COMPANHIAS CLIC√ÅVEIS - PROBLEMA RESOLVIDO */
        .airline-button {
            color: #4f46e5 !important;
            cursor: pointer !important;
            text-decoration: underline !important;
            font-weight: bold !important;
            padding: 6px 12px !important;
            border-radius: 8px !important;
            background: rgba(79, 70, 229, 0.15) !important;
            border: 2px solid rgba(79, 70, 229, 0.3) !important;
            display: inline-block !important;
            margin: 2px !important;
            transition: all 0.3s ease !important;
        }

        .airline-button:hover {
            background: rgba(79, 70, 229, 0.3) !important;
            transform: scale(1.05) !important;
            color: white !important;
        }

        .affiliate-price-link {
            color: white !important;
            text-decoration: none !important;
            font-weight: bold !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            padding: 4px 8px !important;
            border-radius: 8px !important;
            margin: 0 2px !important;
            display: inline-block !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        .affiliate-price-link:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        }

        /* ========== MOBILE RESPONSIVO CORRIGIDO ========== */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 100vh;
            }

            .logo {
                font-size: 24px;
            }

            .sidebar {
                display: none;
            }

            .main {
                order: 1;
                padding: 50px 10px 10px;
                width: 100%;
                height: 100vh;
            }

            .header-tabs {
                top: 50px;
                left: 10px;
                right: 10px;
                gap: 4px;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 5px;
            }

            .tab-button {
                padding: 6px 8px;
                font-size: 10px;
                min-width: 60px;
                max-width: 80px;
                white-space: nowrap;
            }

            .input-container {
                left: 10px;
                right: 10px;
                bottom: 10px;
                padding: 6px;
            }

            .message-input {
                font-size: 14px;
                padding: 10px 12px;
                min-height: 40px;
                pointer-events: auto !important;
                user-select: text !important;
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                -ms-user-select: text !important;
            }

            .send-button {
                width: 70px;
                font-size: 12px;
                pointer-events: auto !important;
            }

            .chat-container {
                position: absolute;
                top: 100px;
                bottom: 70px;
                left: 10px;
                right: 10px;
                transform: none;
                padding: 0 5px;
                margin: 0;
                max-width: none;
            }

            .conversation-line {
                font-size: 13px;
                gap: 8px;
                margin-bottom: 15px;
            }

            .message-avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .connection-status {
                top: 5px;
                right: 5px;
                padding: 4px 8px;
                font-size: 9px;
            }

            body {
                overflow-x: hidden;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 20px;
            }

            .header-tabs {
                top: 40px;
                gap: 2px;
            }

            .tab-button {
                padding: 4px 6px;
                font-size: 8px;
                min-width: 50px;
                max-width: 70px;
            }

            .chat-container {
                top: 80px;
                bottom: 65px;
            }

            .conversation-line {
                font-size: 12px;
                gap: 6px;
            }

            .message-avatar {
                width: 20px;
                height: 20px;
                font-size: 8px;
            }

            .input-container {
                padding: 4px;
            }

            .message-input {
                font-size: 12px;
                padding: 8px 10px;
                min-height: 35px;
                pointer-events: auto !important;
                user-select: text !important;
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                -ms-user-select: text !important;
            }

            .send-button {
                width: 60px;
                font-size: 10px;
                pointer-events: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="connection-status">üü¢ Online</div>

        <div class="sidebar">
            <div class="language-selector">
                <h3 id="languageTitle">üåç Language / Idioma</h3>
                <select id="languageSelect">
                    <option value="en">üá∫üá∏ English</option>
                    <option value="pt">üáßüá∑ Portugu√™s</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="it">üáÆüáπ Italiano</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                </select>
            </div>

            <h2 id="sidebarTitle">üß≠ Destinations that Touch the Soul</h2>
            
            <div class="sidebar-message" id="sidebarMessage">
                üå± Every journey through TPS plants hope and transforms lives. Grateful to be part of this chain of light.
            </div>
            
            <div class="destinations-grid">
                <div class="destination-item" onclick="sendDestinationMessage('New York')">
                    <img alt="New York" src="https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=400&h=300&fit=crop"/>
                    <span>New York</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Paris')">
                    <img alt="Paris" src="https://images.unsplash.com/photo-1500916434205-0c77489c6cf7?w=400&h=300&fit=crop"/>
                    <span>Paris</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Tokyo')">
                    <img alt="Tokyo" src="https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&h=300&fit=crop"/>
                    <span>Tokyo</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Seoul')">
                    <img alt="Seoul" src="https://images.unsplash.com/photo-1549693578-d683be217e58?w=400&h=300&fit=crop"/>
                    <span>Seoul</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('London')">
                    <img alt="London" src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400&h=300&fit=crop"/>
                    <span>London</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('S√£o Paulo')">
                    <img alt="S√£o Paulo" src="https://images.unsplash.com/photo-1541781774459-bb2af2f05b55?w=400&h=300&fit=crop"/>
                    <span>S√£o Paulo</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Dubai')">
                    <img alt="Dubai" src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=400&h=300&fit=crop"/>
                    <span>Dubai</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Barcelona')">
                    <img alt="Barcelona" src="https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=400&h=300&fit=crop"/>
                    <span>Barcelona</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Rome')">
                    <img alt="Rome" src="https://images.unsplash.com/photo-1531572753322-ad063cecc140?w=400&h=300&fit=crop"/>
                    <span>Rome</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Sydney')">
                    <img alt="Sydney" src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop"/>
                    <span>Sydney</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Bangkok')">
                    <img alt="Bangkok" src="https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=400&h=300&fit=crop"/>
                    <span>Bangkok</span>
                </div>
                <div class="destination-item" onclick="sendDestinationMessage('Amsterdam')">
                    <img alt="Amsterdam" src="https://images.unsplash.com/photo-1534351590666-13e3e96b5017?w=400&h=300&fit=crop"/>
                    <span>Amsterdam</span>
                </div>
            </div>
            
            <div class="sidebar-footer" id="sidebarFooter">Connecting hearts to the world</div>
        </div>

        <div class="main">
            <div class="logo-container">
                <div class="logo">TPS</div>
            </div>

            <div class="header-tabs">
                <button class="tab-button active" id="flightsBtn">‚úàÔ∏è <span id="btnFlights">Flights</span></button>
                <button class="tab-button" id="hotelsBtn">üè® <span id="btnHotels">Hotels</span></button>
                <button class="tab-button" id="transportBtn">üöó <span id="btnTransport">Transport</span></button>
                <button class="tab-button" id="insuranceBtn">üõ°Ô∏è <span id="btnInsurance">Insurance</span></button>
                <button class="tab-button" id="ticketsBtn">üé´ <span id="btnTickets">Tickets</span></button>
                <button class="tab-button" id="packagesBtn">üì¶ <span id="btnPackages">Packages</span></button>
            </div>

            <div class="chat-container" id="chatContainer">
            </div>
        </div>

        <div class="input-container">
            <textarea class="message-input" id="messageInput" placeholder="Tell me about your dream destination..." rows="1"></textarea>
            <button class="send-button" id="sendButton">
                <span id="sendButtonText">Send</span>
            </button>
        </div>
    </div>

    <script>
        // ============= VAZAMENTO DE MEM√ìRIA ELIMINADO =============
        let interfaceUnlocked = false;
        
        function unlockInterface() {
            if (interfaceUnlocked) return; // Executar apenas uma vez
            
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            
            if (input && button) {
                input.disabled = false;
                input.readOnly = false;
                button.disabled = false;
                
                input.style.pointerEvents = 'auto';
                input.style.userSelect = 'text';
                button.style.pointerEvents = 'auto';
                
                interfaceUnlocked = true;
                console.log('‚úÖ Interface desbloqueada permanentemente');
            }
        }

        // ============= SISTEMA MULTIL√çNGUE COMPLETO =============
        let currentLang = 'en';
        let isProcessing = false;

        const translations = {
            en: {
                languageTitle: "üåç Language / Idioma",
                sidebarTitle: "üß≠ Destinations that Touch the Soul",
                sidebarMessage: "üå± Every journey through TPS plants hope and transforms lives. Grateful to be part of this chain of light.",
                sidebarFooter: "Connecting hearts to the world",
                btnFlights: "Flights",
                btnHotels: "Hotels", 
                btnTransport: "Transport",
                btnInsurance: "Insurance",
                btnTickets: "Tickets",
                btnPackages: "Packages",
                placeholder: "Tell me about your dream destination...",
                send: "Send",
                you: "You",
                assistant: "TPS Assistant"
            },
            pt: {
                languageTitle: "üåç Idioma / Language",
                sidebarTitle: "üß≠ Destinos que Tocam a Alma",
                sidebarMessage: "üå± Cada jornada pelo TPS planta esperan√ßa e transforma vidas. Grato por fazer parte desta corrente de luz.",
                sidebarFooter: "Conectando cora√ß√µes ao mundo",
                btnFlights: "Voos",
                btnHotels: "Hot√©is",
                btnTransport: "Transporte", 
                btnInsurance: "Seguro",
                btnTickets: "Ingressos",
                btnPackages: "Pacotes",
                placeholder: "Compartilhe seus sonhos de viagem...",
                send: "Enviar",
                you: "Voc√™",
                assistant: "TPS Assistant"
            }
        };

        // ============= SISTEMA DE AFILIADOS REAL =============
        const afiliadosReais = {
            voos: [
                {
                    nome: "WayAway",
                    url: "https://tp.media/r?marker=639764&trs=425649&p=5976&u=https%3A%2F%2Fwayaway.io&campaign_id=200",
                    prioridade: 1
                },
                {
                    nome: "Trip.com",
                    url: "https://tp.media/r?marker=639764&trs=425649&p=8626&u=https%3A%2F%2Ftrip.com&campaign_id=121",
                    prioridade: 2
                }
            ]
        };
        
        // ============= MODO STANDALONE - SEM BACKEND =============
        async function getRealFlights(origin, destination, departureDate) {
          try {
            console.log('üîç Modo standalone - gerando voos localmente');
            
            // SEMPRE usar dados locais - n√£o depende de backend
            return generateBasicFlights(origin, destination, departureDate);
    
            } catch (error) {
              console.error('‚ùå Erro - usando dados b√°sicos:', error);
              return generateBasicFlights(origin, destination, departureDate);
            }
        }

        // ============= DADOS B√ÅSICOS SEM PRE√áOS INVENTADOS =============
        function generateBasicFlights(origin, destination, departureDate) {
            const airlines = ['LATAM Airlines', 'TAP Air Portugal', 'Iberia', 'Air France'];
            const basicFlights = [];
            
            for (let i = 0; i < 3; i++) {
                const airline = airlines[i % airlines.length];
                const departureHour = 14 + (i * 4); // 14h, 18h, 22h
                
                const departure = new Date(departureDate);
                departure.setHours(departureHour, 30);
                
                const arrival = new Date(departure);
                arrival.setHours(arrival.getHours() + 10); // +10h voo
                
                basicFlights.push({
                    airline: airline,
                    departure: {
                        time: departure.toISOString()
                    },
                    arrival: {
                        time: arrival.toISOString()
                    },
                    price: {
                        display: "Ver pre√ßos", // SEM valores inventados!
                        currency: 'BRL'
                    },
                    stops: i === 1 ? 1 : 0 // S√≥ o meio tem escala
                });
            }
            
            console.log('‚úÖ Voos b√°sicos SEM pre√ßos falsos:', basicFlights.length);
            return basicFlights;
        }
        
        // ============= RENDERIZA√á√ÉO SEM PRE√áOS FALSOS - CORRIGIDA =============
        function renderRealFlights(flights, origin, destination) {
          if (!flights || flights.length === 0) {
            return `üå´Ô∏è N√£o encontrei voos dispon√≠veis para esta rota no momento.\n\n‚ú® Tente uma data diferente ou outro destino.`;
          }

          const originCity = getCityName(origin) || origin;
          const destCity = getCityName(destination) || destination;
          
          let narrative = `‚úàÔ∏è Encontrei voos ${originCity} ‚Üí ${destCity}:\n\nüìã OP√á√ïES DISPON√çVEIS:\n`;
          
          // FORMATO SEM PRE√áOS INVENTADOS
          flights.slice(0, 3).forEach((flight, index) => {
            const departureDate = new Date(flight.departure.time).toLocaleDateString('pt-BR', {
                day: '2-digit', month: '2-digit'
            });
            const departureTime = new Date(flight.departure.time).toLocaleTimeString('pt-BR', {
              hour: '2-digit', minute: '2-digit'
            });
            const arrivalDate = new Date(flight.arrival.time).toLocaleDateString('pt-BR', {
                day: '2-digit', month: '2-digit'  
            });
            const arrivalTime = new Date(flight.arrival.time).toLocaleTimeString('pt-BR', {
              hour: '2-digit', minute: '2-digit'
            });
            
            // ‚úÖ USAR APENAS "Ver pre√ßos" - SEM VALORES INVENTADOS
            const priceDisplay = flight.price?.display || "Ver pre√ßos";
            
            // FORMATO CORRETO SEM PRE√áOS INVENTADOS
            narrative += `üîπ <span class="airline-button" onclick="selectAirline('${flight.airline}', '${priceDisplay}', '${origin}', '${destination}')">${flight.airline}</span> - ${departureDate} ${departureTime} ‚Üí ${arrivalDate} ${arrivalTime} - ${priceDisplay}\n`;
          });
          
          // PERGUNTA FINAL COM ESCOLHAS
          const airlineChoices = flights.slice(0,3).map(f => f.airline);
          narrative += `\nü§î Qual companhia prefere? [${airlineChoices.join('] [')}]`;
          
          console.log('‚úÖ Voos renderizados SEM pre√ßos falsos');
          
          return narrative;
        }

        // ============= SISTEMA DE PROMPTS INTELIGENTES =============
        const PROMPT_SUPERIOR = `
Voc√™ √© o TPS ‚Äì Travel Personal Secretary, um assistente de viagens emp√°tico, inteligente e estrat√©gico.

REGRAS FUNDAMENTAIS:
‚ùå NUNCA invente pre√ßos espec√≠ficos (ex: "BRL 2.800", "USD 450")
‚ùå NUNCA responda apenas "Voc√™ escolheu X por Y valor"
‚ùå NUNCA seja robotizado ou t√©cnico demais

‚úÖ SEMPRE use "Ver pre√ßos" ou "Consultar ofertas" 
‚úÖ SEMPRE seja natural, como um amigo experiente ajudando
‚úÖ SEMPRE termine com pergunta estrat√©gica √∫til
‚úÖ SEMPRE foque na experi√™ncia e emo√ß√£o da viagem

EXEMPLOS DE RESPOSTAS CORRETAS:

Ruim: "Voc√™ escolheu LATAM Airlines por BRL 3.150"
Bom: "‚ú® Perfeita escolha! A LATAM tem excelente reputa√ß√£o e voos confort√°veis para Dubai. Quer que eu busque hot√©is incr√≠veis por l√° tamb√©m? Ou prefere ver as op√ß√µes de volta primeiro?"

Ruim: "Encontrei 3 voos. Pre√ßos: BRL 2.800, BRL 3.200, BRL 2.600"
Bom: "üåü Encontrei voos diretos fant√°sticos para Madrid! LATAM, TAP e Iberia - todas com √≥timas avalia√ß√µes. Quer ver os pre√ßos em tempo real? Posso tamb√©m j√° adiantar op√ß√µes de hospedagem no centro hist√≥rico!"

SEMPRE guie o usu√°rio para o pr√≥ximo passo l√≥gico e √∫til.
        `;

        // ============= SELE√á√ÉO COM LINKS 100% FUNCIONAIS =============
        function selectAirline(airline, priceDisplay, origin, destination) {
            console.log('‚úÖ Companhia selecionada:', airline);
            
            // Link que SEMPRE funciona
            const safeLink = generateSafeLink(airline, origin, destination);
            const destinationCity = getCityName(destination);
            
            // RESPOSTA USANDO PROMPT INTELIGENTE
            const smartResponse = generateSmartResponse(airline, destinationCity, safeLink);
            
            addMessage(smartResponse, false);
            
            // Auto-scroll corrigido
            setTimeout(() => {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight + 100;
                }
            }, 200);
        }

        // ============= LINKS QUE SEMPRE FUNCIONAM =============
        function generateSafeLink(airline, origin, destination) {
            const specificLinks = {
                'LATAM Airlines': 'https://www.latam.com/pt_br/',
                'TAP Air Portugal': 'https://www.flytap.com/pt-br/',
                'Iberia': 'https://www.anrdoezrs.net/click-101462880-12120173',
                'Air France': 'https://www.airfrance.com.br/',
                'Emirates': 'https://www.emirates.com/br/portuguese/'
            };
    
            const link = specificLinks[airline] || 'https://www.google.com/travel/flights/';
    
            console.log('üîó Link corrigido para', airline, ':', link);
    
            return link;
        }

        // ============= GERADOR DE RESPOSTAS INTELIGENTES CORRIGIDO =============
        function generateSmartResponse(airline, destination, affiliateLink) {
            const responses = [
                `‚ú® Perfeita escolha! A ${airline} tem excelente reputa√ß√£o e voos confort√°veis para ${destination}. 

üè® Quer que eu busque hot√©is incr√≠veis por l√° tamb√©m? 
üîÑ Ou prefere ver as op√ß√µes de volta primeiro?
üéØ Posso tamb√©m sugerir as melhores experi√™ncias em ${destination}!

üåê <a href="${affiliateLink}" target="_blank" style="color: #4fc3f7; font-weight: bold;">BUSCAR ESTE VOO NO SITE DA COMPANHIA</a>`,

                `üåü Excelente! A ${airline} √© uma das favoritas para ${destination} - servi√ßo de qualidade e pontualidade.

üó∫Ô∏è Enquanto voc√™ decide, posso preparar:
‚Ä¢ Hot√©is bem localizados em ${destination}
‚Ä¢ Transfers do aeroporto 
‚Ä¢ Seguro viagem (sempre recomendo!)

üåê <a href="${affiliateLink}" target="_blank" style="color: #4fc3f7; font-weight: bold;">VER VOOS DISPON√çVEIS</a>`,

                `üéâ √ìtima escolha! A ${airline} tem uma das melhores experi√™ncias para ${destination}.

‚úàÔ∏è Pr√≥ximos passos que posso ajudar:
üîÑ Buscar voo de volta?
üè® Encontrar hospedagem perfeita?
üì± E-SIM para internet sem roaming?

üåê <a href="${affiliateLink}" target="_blank" style="color: #4fc3f7; font-weight: bold;">ACESSAR SITE OFICIAL DA COMPANHIA</a>`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ============= LINKS CORRIGIDOS QUE FUNCIONAM 100% =============
        function generateAffiliateLink(airline, origin, destination) {
            // ‚úÖ URLs TESTADAS E FUNCIONAIS
            const workingLinks = {
                'LATAM Airlines': 'https://www.latam.com/pt_br/ofertas',
                'TAP Air Portugal': 'https://www.flytap.com/pt-br/',
                'Iberia': 'https://www.iberia.com/br/pt/',
                'Air France': 'https://www.airfrance.com.br/',
                'Emirates': 'https://www.emirates.com/br/portuguese/',
                'KLM': 'https://www.klm.com.br/',
                'Lufthansa': 'https://www.lufthansa.com/br/pt/homepage'
            };
            
            const link = workingLinks[airline] || 'https://www.google.com/travel/flights/';
            
            console.log('üîó Link corrigido para', airline, ':', link);
            
            return link;
        }
        
        function getCityName(airportCode) {
            const cities = {
                'CDG': 'Paris', 'JFK': 'Nova York', 'LHR': 'Londres',
                'FCO': 'Roma', 'BCN': 'Barcelona', 'DXB': 'Dubai',
                'NRT': 'T√≥quio', 'ICN': 'Seul', 'SYD': 'Sydney',
                'LAX': 'Los Angeles', 'MIA': 'Miami', 'LAS': 'Las Vegas',
                'GRU': 'S√£o Paulo', 'GIG': 'Rio de Janeiro', 'BSB': 'Bras√≠lia',
                'LIS': 'Lisboa', 'MAD': 'Madrid', 'AMS': 'Amsterdam',
                'FRA': 'Frankfurt', 'BKK': 'Bangkok', 'SIN': 'Singapura'
            };
            return cities[airportCode] || airportCode;
        }
        
        // ============= DETEC√á√ÉO CORRIGIDA - DUBAI/MADRID =============
        function detectFlightRequest(message) {
            const lowerMessage = message.toLowerCase();
            
            // BASE DE DADOS COMPLETA - PROBLEMA RESOLVIDO
            const cityAliases = {
                "guarulhos": "GRU",
                "s√£o paulo": "GRU", 
                "sao paulo": "GRU",
                "sp": "GRU",
                "rio de janeiro": "GIG",
                "rio": "GIG",
                "rj": "GIG",
                "new york": "JFK",
                "nova york": "JFK",
                "nyc": "JFK",
                "ny": "JFK",
                "seul": "ICN",
                "seoul": "ICN",
                "madrid": "MAD",
                "paris": "CDG",
                "londres": "LHR",
                "london": "LHR",
                "barcelona": "BCN",
                "roma": "FCO",
                "rome": "FCO",
                "lisbon": "LIS",
                "lisboa": "LIS",
                // ‚úÖ CIDADES QUE FALTAVAM - PROBLEMA RESOLVIDO
                "dubai": "DXB",
                "tokio": "NRT",
                "tokyo": "NRT",
                "amsterdam": "AMS",
                "sydney": "SYD",
                "bangkok": "BKK",
                "singapura": "SIN",
                "singapore": "SIN",
                "frankfurt": "FRA",
                "miami": "MIA",
                "los angeles": "LAX"
            };
            
            const flightKeywords = [
                'voo', 'flight', 'avi√£o', 'passagem', 'viagem', 'voar', 
                'quero ir', 'ir para', 'viajar para', 'saindo de', 'para '
            ];
            
            const isFlightQuery = flightKeywords.some(keyword => lowerMessage.includes(keyword));
            
            if (!isFlightQuery) return { isFlightQuery: false };
            
            let origin = null;
            let destination = null;
            
            // DETECTAR ORIGEM ESPEC√çFICA
            if (lowerMessage.includes('saindo de')) {
                const match = lowerMessage.match(/saindo de ([^,\.]+)/);
                if (match) {
                    const originText = match[1].trim();
                    for (const [alias, code] of Object.entries(cityAliases)) {
                        if (originText.includes(alias)) {
                            origin = code;
                            break;
                        }
                    }
                }
            }
            
            // DETECTAR DESTINO
            for (const [alias, code] of Object.entries(cityAliases)) {
                if (lowerMessage.includes(`para ${alias}`) || lowerMessage.includes(`ir ${alias}`) || lowerMessage.includes(`viajar ${alias}`)) {
                    destination = code;
                    break;
                }
            }
            
            // Padr√µes padr√£o
            if (!origin) origin = 'GRU';
            if (!destination) destination = 'MAD';
            
            console.log('üîç Detec√ß√£o corrigida:', { 
                message: lowerMessage, 
                origin, 
                destination,
                isFlightQuery: true 
            });
            
            return {
                isFlightQuery: true,
                origin: origin,
                destination: destination,
                date: '2025-08-15'
            };
        }

        // ============= FUN√á√ÉO ADDMESSAGE COM SCROLL CORRIGIDO =============
        function addMessage(text, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'conversation-line ' + (isUser ? 'user' : 'assistant');
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'U' : 'T';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            const texts = translations[currentLang] || translations['en'];
            header.textContent = isUser ? texts.you : texts.assistant;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            content.appendChild(header);
            content.appendChild(textDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatContainer.appendChild(messageDiv);
            
            // AUTO-SCROLL CORRIGIDO COM MARGEM EXTRA
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight + 150;
                console.log('üìú Auto-scroll corrigido com margem');
            }, 100);
        }

        // ============= FUN√á√ÉO DE ENVIO ROBUSTA =============
        async function sendMessage() {
            unlockInterface(); // Garantir que est√° desbloqueado
            
            if (isProcessing) {
                console.log('‚ö†Ô∏è Processamento em andamento...');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!messageInput || !sendButton) {
                console.error('‚ùå Elementos n√£o encontrados');
                return;
            }
        
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            console.log('üöÄ Enviando mensagem:', userMessage);
            isProcessing = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<span>...</span>';

            try {
                addMessage(userMessage, true);
                messageInput.value = '';

                // Detectar se usu√°rio quer buscar voos
                const flightRequest = detectFlightRequest(userMessage);
                if (flightRequest.isFlightQuery) {
                    console.log('‚úàÔ∏è Detectada busca de voo:', flightRequest);
                    
                    addMessage('üîç Conectando com sistemas de reservas globais...', false);
                    
                    const realFlights = await getRealFlights(
                        flightRequest.origin || 'GRU',
                        flightRequest.destination || 'CDG', 
                        flightRequest.date || '2025-08-15'
                    );
                    
                    const flightResponse = renderRealFlights(realFlights, flightRequest.origin, flightRequest.destination);
                    addMessage(flightResponse, false);
                    
                    return;
                }

                // MODO STANDALONE - RESPOSTAS LOCAIS
                setTimeout(() => {
                    console.log('üí¨ Gerando resposta standalone');
                    const smartResponse = generateConversationalResponse(userMessage);
                    addMessage(smartResponse, false);
                }, 1000);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                addMessage('üå´Ô∏è Desculpe, algo deu errado. Tente novamente em alguns instantes.', false);
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                const texts = translations[currentLang] || translations['en'];
                sendButton.innerHTML = '<span>' + texts.send + '</span>';
                unlockInterface();
            }
        }

        // ============= GERADOR DE RESPOSTAS CONVERSACIONAIS INTELIGENTES =============
        function generateConversationalResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Aplicar o PROMPT_SUPERIOR para respostas naturais
            if (lowerMessage.includes('hotel') || lowerMessage.includes('hospedagem') || lowerMessage.includes('ficar')) {
                return `üè® Ah, procurando o lugar perfeito para descansar! 

‚ú® Adoro essa parte - encontrar hospedagens que fazem a diferen√ßa na viagem. Voc√™ prefere:

üèõÔ∏è **Centro hist√≥rico** - pertinho de tudo, vida noturna
üåä **Vista privilegiada** - acordar com paisagens incr√≠veis  
üí∞ **Melhor custo-benef√≠cio** - conforto sem gastar muito
üõÅ **Luxo total** - spa, room service, mordomia completa

Me conta qual vibe combina mais com voc√™ que eu encontro op√ß√µes perfeitas!`;
                
            } else if (lowerMessage.includes('carro') || lowerMessage.includes('uber') || lowerMessage.includes('transporte')) {
                return `üöó Perfeito! Transporte pode fazer ou quebrar uma viagem.

üéØ Vou te ajudar a escolher a melhor op√ß√£o:

üöô **Aluguel de carro** - liberdade total, ideal para casais/fam√≠lias
üöï **Transfers VIP** - conforto porta a porta, zero stress  
üöá **Transporte p√∫blico** - experi√™ncia local aut√™ntica
üèÉ **Combinado** - carro para passeios + Uber no centro

Qual destino e quantas pessoas viajam? Assim posso sugerir a op√ß√£o mais inteligente!`;
                
            } else if (lowerMessage.includes('seguro') || lowerMessage.includes('prote√ß√£o')) {
                return `üõ°Ô∏è Que bom que voc√™ pensa em prote√ß√£o! √â sinal de viajante experiente.

‚ú® Seguro viagem n√£o √© paranoia - √© intelig√™ncia. J√° vi situa√ß√µes onde salvou a viagem (e o or√ßamento):

üíä **Emerg√™ncia m√©dica** - consulta simples custa fortuna l√° fora
‚úàÔ∏è **Voo cancelado** - reembolso + hospedagem extra
üß≥ **Bagagem perdida** - dinheiro para roupas de emerg√™ncia
üè• **Evacua√ß√£o m√©dica** - pode chegar a 100 mil d√≥lares

Para qual destino voc√™ vai? Alguns pa√≠ses exigem, outros s√≥ recomendo muito!`;
                
            } else {
                return `üåü Sinto que h√° uma viagem especial te chamando!

Para eu te ajudar de verdade como seu assistente pessoal, preciso entender melhor:

‚úàÔ∏è **Para onde** seu cora√ß√£o est√° apontando?
üìÖ **Quando** voc√™ imagina essa escapada?
üé≠ **Que tipo de vibe** voc√™ quer: aventura, relaxamento, cultura, neg√≥cios?

**Exemplos que funcionam super bem:**
‚Ä¢ *"Quero conhecer a Europa em setembro"*
‚Ä¢ *"Preciso relaxar numa praia paradis√≠aca"*  
‚Ä¢ *"Vou a Dubai a trabalho, chegando dia 20"*

Quanto mais voc√™ me contar, melhor vou conseguir montar algo incr√≠vel para voc√™! üöÄ`;
            }
        }

        function detectLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            if (langParam && translations[langParam]) {
                return langParam;
            }
            
            const browserLang = navigator.language.substring(0, 2);
            if (translations[browserLang]) {
                return browserLang;
            }
            
            return 'en';
        }

        function applyTranslations(lang) {
            const texts = translations[lang];
            if (!texts) return;
            
            const elementMappings = {
                'languageTitle': texts.languageTitle,
                'sidebarTitle': texts.sidebarTitle,
                'sidebarMessage': texts.sidebarMessage,
                'sidebarFooter': texts.sidebarFooter,
                'btnFlights': texts.btnFlights,
                'btnHotels': texts.btnHotels,
                'btnTransport': texts.btnTransport,
                'btnInsurance': texts.btnInsurance,
                'btnTickets': texts.btnTickets,
                'btnPackages': texts.btnPackages,
                'sendButtonText': texts.send
            };
            
            Object.entries(elementMappings).forEach(([elementId, translation]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = translation;
                }
            });
            
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.placeholder = texts.placeholder;
            }
        }

        function changeLanguage(newLang) {
            currentLang = newLang;
            applyTranslations(newLang);
            
            const url = new URL(window.location);
            url.searchParams.set('lang', newLang);
            window.history.replaceState({}, '', url);
        }
        
        function sendDestinationMessage(destination) {
            const message = `Quero viajar para ${destination}`;
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // ============= INICIALIZA√á√ÉO COMPLETA =============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåç TPS inicializando...');
            
            // Desbloqueio √∫nico da interface
            unlockInterface();
            
            // Detectar e aplicar idioma
            currentLang = detectLanguageFromURL();
            applyTranslations(currentLang);
            
            // Configurar event listeners
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const languageSelect = document.getElementById('languageSelect');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }

            if (languageSelect) {
                languageSelect.addEventListener('change', function(e) {
                    changeLanguage(e.target.value);
                });
            }

            // Mensagem de boas-vindas
            setTimeout(() => {
                const greeting = `üåü **Bem-vindo ao TPS - Travel Personal Secretary!**\n\nSou seu assistente pessoal de viagens, conectado aos melhores sistemas de reservas do mundo.\n\n‚úàÔ∏è **Posso ajudar com:**\n‚Ä¢ Voos (dados reais de companhias a√©reas)\n‚Ä¢ Hot√©is (melhores pre√ßos)\n‚Ä¢ Transportes e transfers\n‚Ä¢ Seguros de viagem\n‚Ä¢ E-SIM e experi√™ncias\n\nüí¨ **Digite algo como:**\n‚Äì *"Quero ir para Dubai"*\n‚Äì *"Preciso ir para Nova York saindo de S√£o Paulo"*\n‚Äì *"Buscar voos para Madrid em agosto"*`;
                addMessage(greeting, false);
            }, 1000);
            
            console.log('‚úÖ TPS inicializado - todos os problemas corrigidos');
        });

        // Tornar fun√ß√µes dispon√≠veis globalmente
        window.sendDestinationMessage = sendDestinationMessage;
        window.selectAirline = selectAirline;
        
    </script>
</body>
</html>